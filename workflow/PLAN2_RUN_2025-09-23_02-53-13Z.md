Resumen de generación – Plan 2 (event_based)

- Fecha/hora: 2025-09-01T10:00:00.000Z
- childId: 68d1af5315d0e9b1cc189544
- userId (owner): 68d1a9b07e63c75df18e1c1c
- admin (createdBy): 68d1a9337e63c75df18e1c1b (mariana@admin.com)
- planId: 68d216e67e7d0a3702d8debe
- planNumber: 2
- planVersion: "2"
- planType: event_based


En palabras simples (para PM)

- Parte del Plan 1.1 (el último que tenías) y lo ajusta con lo que pasó en agosto.
- Lee datos reales desde que se creó el Plan 1.1 (01/08/2025 20:05Z) hasta el 01/09/2025 (inicio del día).
- Con esos datos calcula: hora típica de dormir y despertar, siesta típica (hora y duración) y horas típicas de comidas.
- El nuevo horario respeta el estilo del 1.1 pero se mueve según esos datos reales.

Qué se usa exactamente (explícito y escalable)

- Base de schedule (contenido): último plan activo de cualquier tipo → Plan 1.1 (transcript_refinement). Se toma su `schedule` como punto de partida para mantener coherencia.
- Base para ventana de eventos (estadísticas): último plan previo (incluye refinamientos) → Plan 1.1. Se toma su `createdAt` como `fromDate` y el 01/09/2025 00:00Z como `toDate`.
- Fuente de eventos: colección canónica `events` (MongoDB). Fallback legacy: `children.events` si `events` no existe o está vacío.
- Filtro de eventos: `startTime > fromDate.toISOString()` y `startTime <= toDate.toISOString()`; ordenados por `startTime` ascendente.
- Rango aplicado en esta corrida: from=2025-08-01T20:05:56.000Z (createdAt de Plan 1.1) → to=2025-09-01T00:00:00.000Z.
- Cobertura: incluye los 178 eventos insertados por `scripts/seed-august-2025.js` más cualquier evento adicional hasta la hora de generación.
- Estadísticas computadas (sobre el rango):
  - processSleepStatistics(newEvents, fromDate): métricas base de sueño
  - Enriquecidas para el prompt:
    - Bedtime promedio (a partir de `sleep.startTime`): `computeBedtimeAvgFromEvents`
    - Siestas: conteo, duración promedio y “hora típica” (promedio de inicios) `computeNapStatsFromEvents`
    - Comidas típicas: horas promedio por desayuno/almuerzo/merienda/cena `computeFeedingTypicalTimesFromEvents`
- Políticas de ajuste: `derivePlanPolicy({ ageInMonths, events })` con ventana de transición de siestas (15–18 meses) y reglas de destete nocturno si hay eventos `night_feeding` recientes.
- RAG: vector store en MongoDB (hasta 6 fuentes únicas) con queries temáticas; se incluye la lista de `ragSources` en el plan.
- IA: `openai.chat.completions` (modelo gpt-4) con prompt estructurado; si falla el parseo se usa fallback consistente.

Salida (resumen)

- basedOn: "events_stats_rag"
- Base de progresión: v1.1 (schedule) + estadísticas del rango (desde v1.1)
- schedule: actualizado por IA en coherencia con 1.1 y los eventos recientes
- eventAnalysis:
  - dateRange.from: 2025-08-01T20:05:56.000Z
  - dateRange.to: 2025-09-01T00:00:00.000Z
  - eventsAnalyzed: 173
  - basePlanVersion: "1.1"
  - ragSources: [] (esta corrida backdated no forzó RAG)

Consultas de auditoría (Mongo)

- Eventos usados (conteo y tipos):
  db.events.aggregate([
    { $match: { childId: ObjectId('68d1af5315d0e9b1cc189544'), startTime: { $gt: '2025-08-01T20:05:56.000Z', $lte: '2025-09-01T00:00:00.000Z' } } },
    { $group: { _id: '$eventType', n: { $sum: 1 } } }
  ])
- Ver plan 2:
  db.child_plans.find({ _id: ObjectId('68d216e67e7d0a3702d8debe') })
- Ver plan base usado (1.1):
  db.child_plans.find({ childId: ObjectId('68d1af5315d0e9b1cc189544'), planVersion: '1.1' }).limit(1)
