// Script para generar Plan 1.1 de Esteban - 16 de junio 2025 (despu√©s de consulta)
// Emula exactamente el flujo implementado: Plan 1 + Transcript Analysis + RAG

require('dotenv').config()
const { MongoClient, ObjectId } = require('mongodb')

const MONGODB_URI = process.env.MONGODB_URI
const USER_ID = '688ce146d2d5ff9616549d86'
const ESTEBAN_ID = '68ad0476b98bdbe0f7ff5942'
const ADMIN_ID = '687999869a879ac61e9fb873' // ID del admin que genera el plan

async function generarPlan1_1Esteban() {
  try {
    console.log('üåü GENERAR PLAN 1.1 PARA ESTEBAN - 16 JUNIO 2025')
    console.log('===============================================')
    console.log('üìä Fuentes: Plan 1 + Transcript Analysis + RAG')
    
    const client = new MongoClient(MONGODB_URI)
    await client.connect()
    console.log('‚úÖ Conectado a MongoDB')
    
    const db = client.db()
    
    // 1. Verificar Plan 1 existente
    const plan1 = await db.collection('child_plans').findOne({
      childId: new ObjectId(ESTEBAN_ID),
      planVersion: "1"
    })
    
    if (!plan1) {
      console.error('‚ùå No se encontr√≥ Plan 1. Debe existir antes de generar Plan 1.1')
      return
    }
    
    console.log(`\nüìã Plan 1 encontrado:`)
    console.log(`  - Versi√≥n: ${plan1.planVersion}`)
    console.log(`  - Creado: ${plan1.createdAt}`)
    console.log(`  - Tipo: ${plan1.planType}`)
    
    // 2. Buscar el √∫ltimo consultation report con transcript
    const latestConsultation = await db.collection('consultation_reports').findOne(
      { childId: new ObjectId(ESTEBAN_ID) },
      { sort: { createdAt: -1 } }
    )
    
    if (!latestConsultation || !latestConsultation.transcript) {
      console.error('‚ùå No se encontr√≥ consultation report con transcript')
      return
    }
    
    console.log(`\nüìÑ Consultation Report encontrado:`)
    console.log(`  - ID: ${latestConsultation._id}`)
    console.log(`  - Fecha: ${latestConsultation.createdAt}`)
    console.log(`  - Transcript: ${latestConsultation.transcript.substring(0, 100)}...`)
    console.log(`  - An√°lisis: ${latestConsultation.analysis.substring(0, 100)}...`)
    
    // 3. Verificar datos del ni√±o
    const child = await db.collection('children').findOne({
      _id: new ObjectId(ESTEBAN_ID)
    })
    
    if (!child) {
      console.error('‚ùå No se encontr√≥ a Esteban')
      return
    }
    
    console.log(`\nüë∂ Ni√±o: ${child.firstName} ${child.lastName}`)
    
    // 4. Calcular edad en meses
    const birthDate = new Date(child.birthDate)
    const now = new Date('2025-06-16') // Fecha del plan 1.1
    const ageInMonths = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24 * 30.44))
    console.log(`üë∂ Edad: ${ageInMonths} meses`)
    
    // 5. Generar Plan 1.1 con refinamientos m√©dicos
    console.log(`\nü§ñ Generando Plan 1.1 con refinamientos del transcript...`)
    
    const plan1_1 = {
      _id: new ObjectId(),
      childId: new ObjectId(ESTEBAN_ID),
      userId: new ObjectId(USER_ID),
      planNumber: 1,
      planVersion: "1.1",
      planType: "transcript_refinement",
      
      // Horarios refinados seg√∫n recomendaciones m√©dicas
      schedule: {
        bedtime: "20:00", // Ajustado: m√°s temprano seg√∫n m√©dico
        wakeTime: "07:00", // Ajustado: despertar m√°s tarde para m√°s descanso
        meals: [
          {
            time: "07:30",
            type: "desayuno",
            description: "Desayuno despu√©s de despertar naturalmente"
          },
          {
            time: "12:30",
            type: "almuerzo", 
            description: "Almuerzo balanceado manteniendo horario"
          },
          {
            time: "16:00",
            type: "merienda",
            description: "Merienda ligera temprana"
          },
          {
            time: "19:00",
            type: "cena",
            description: "Cena temprana para mejor digesti√≥n nocturna"
          }
        ],
        activities: [
          {
            time: "08:00",
            activity: "jugar",
            duration: 60,
            description: "Juego libre matutino - m√°s actividad f√≠sica seg√∫n m√©dico"
          },
          {
            time: "10:00",
            activity: "ejercicio",
            duration: 45,
            description: "Actividad f√≠sica intensa en la ma√±ana"
          },
          {
            time: "17:00",
            activity: "actividad_tranquila",
            duration: 30,
            description: "Actividades tranquilas despu√©s de las 5 PM"
          },
          {
            time: "19:30",
            activity: "rutina_relajacion",
            duration: 30,
            description: "Rutina de relajaci√≥n: lectura y preparaci√≥n para dormir"
          }
        ],
        naps: [
          {
            time: "14:30",
            duration: 45, // Reducido de 75 a 45 minutos seg√∫n m√©dico
            description: "Siesta reducida a 45 min m√°ximo (recomendaci√≥n m√©dica)"
          }
        ]
      },
      
      title: "Plan 1.1 de Refinamiento M√©dico para Esteban",
      objectives: [
        "Reducir siesta a m√°ximo 45-60 minutos seg√∫n recomendaci√≥n m√©dica",
        "Adelantar hora de dormir a 20:00 para mejorar conciliaci√≥n",
        "Aumentar actividad f√≠sica matutina para mejor cansancio nocturno",
        "Implementar rutina de relajaci√≥n estricta 30 min antes de dormir",
        "Establecer 'tiempo tranquilo' si no tiene sue√±o para siesta"
      ],
      recommendations: [
        "Despertar a Esteban si la siesta pasa de 45-60 minutos",
        "Considerar eliminar siesta completamente si persisten problemas",
        "Mantener cuarto entre 18-21¬∞C para √≥ptimo descanso",
        "Implementar 'tiempo tranquilo' con libros si no quiere dormir siesta",
        "Ser pacientes: cambios pueden tomar 1-2 semanas en establecerse",
        "Aumentar actividad f√≠sica especialmente en ma√±ana y temprano en tarde",
        "Evitar actividades estimulantes despu√©s de las 6:00 PM"
      ],
      
      basedOn: "transcript_analysis",
      
      // Referencia al plan base
      basedOnPlan: {
        planId: plan1._id,
        planVersion: plan1.planVersion
      },
      
      // Referencia al consultation report
      consultationReport: {
        reportId: latestConsultation._id,
        analysisDate: latestConsultation.createdAt,
        transcriptLength: latestConsultation.transcript.length
      },
      
      // An√°lisis del transcript para refinamiento
      transcriptAnalysis: {
        keyFindings: [
          "Siesta muy larga (90 min) est√° afectando sue√±o nocturno",
          "Dificultad para conciliar el sue√±o en la noche",
          "Despertares tempranos pero con cansancio residual",
          "Inquietud despu√©s de las 5:00 PM",
          "Necesidad de m√°s actividad f√≠sica durante el d√≠a"
        ],
        medicalRecommendations: [
          "Reducir siesta a m√°ximo 45-60 minutos",
          "Considerar eliminar siesta si persisten problemas",
          "Aumentar actividad f√≠sica matutina",
          "Implementar rutina de relajaci√≥n pre-sue√±o",
          "Mantener ambiente fresco (18-21¬∞C)"
        ],
        adjustments: [
          "Hora de dormir: 20:15 ‚Üí 20:00 (15 min m√°s temprano)",
          "Siesta: 75 min ‚Üí 45 min (30 min menos)",
          "Actividad f√≠sica: agregada sesi√≥n matutina de 45 min",
          "Rutina pre-sue√±o: especificada con tiempo tranquilo"
        ],
        improvements: [
          "Mejor conciliaci√≥n del sue√±o nocturno",
          "Reducci√≥n de despertares tempranos",
          "Mayor cansancio natural por m√°s actividad f√≠sica",
          "Rutina m√°s estructurada para relajaci√≥n"
        ],
        ragSources: [
          "Transici√≥n de siesta a los 4-5 a√±os",
          "Impacto de siesta larga en sue√±o nocturno",
          "Actividad f√≠sica y calidad del sue√±o infantil",
          "Rutinas de relajaci√≥n pre-sue√±o"
        ]
      },
      
      createdAt: new Date('2025-06-16T16:00:00.000Z'),
      updatedAt: new Date('2025-06-16T16:00:00.000Z'),
      createdBy: new ObjectId(ADMIN_ID),
      status: "active"
    }
    
    // Marcar Plan 1 como superseded
    await db.collection('child_plans').updateOne(
      { _id: plan1._id },
      { $set: { status: "superseded" } }
    )
    
    // Insertar Plan 1.1
    const result = await db.collection('child_plans').insertOne(plan1_1)
    
    const plan1_1Data = {
      planId: result.insertedId,
      plan: {
        ...plan1_1,
        _id: result.insertedId
      }
    }
    
    console.log('\n‚úÖ PLAN 1.1 GENERADO EXITOSAMENTE')
    console.log('================================')
    console.log(`üìù Plan ID: ${plan1_1Data.planId}`)
    console.log(`üéØ Tipo: ${plan1_1Data.plan.planType} (Plan ${plan1_1Data.plan.planVersion})`)
    console.log(`üìä Basado en: Plan 1 + Transcript Analysis + RAG`)
    console.log(`‚è∞ Horario dormir: ${plan1_1Data.plan.schedule?.bedtime || 'N/A'}`)
    console.log(`üåÖ Horario despertar: ${plan1_1Data.plan.schedule?.wakeTime || 'N/A'}`)
    console.log(`üò¥ Siesta: ${plan1_1Data.plan.schedule?.naps?.[0]?.duration || 'N/A'} min`)
    console.log(`üéØ Objetivos: ${plan1_1Data.plan.objectives?.length || 0}`)
    console.log(`üí° Recomendaciones: ${plan1_1Data.plan.recommendations?.length || 0}`)
    
    // 6. Generar archivo plan1-1.md
    await generarArchivoPlan1_1(plan1_1Data.plan, child, plan1, latestConsultation)
    
    await client.close()
    console.log('\nüéâ PROCESO COMPLETADO')
    
  } catch (error) {
    console.error('‚ùå Error:', error)
    process.exit(1)
  }
}

async function generarArchivoPlan1_1(plan, child, plan1, consultationReport) {
  const fs = require('fs').promises
  
  const contenido = `# Plan 1.1 - ${child.firstName} ${child.lastName}
**Fecha de generaci√≥n:** 16 de junio, 2025  
**Tipo:** Plan de Refinamiento M√©dico  
**Versi√≥n:** ${plan.planVersion}  
**Basado en:** Plan 1 + An√°lisis de Transcript + RAG Knowledge Base

## üë∂ Informaci√≥n del Ni√±o
- **Nombre:** ${child.firstName} ${child.lastName}
- **Fecha nacimiento:** ${child.birthDate}
- **Edad:** ${Math.floor((new Date('2025-06-16') - new Date(child.birthDate)) / (1000 * 60 * 60 * 24 * 30.44))} meses

## üìä Progresi√≥n desde Plan 1

### üìÖ Plan 1 (Base para refinamiento)
- **Creado:** ${plan1.createdAt.toLocaleDateString('es-ES')}
- **Tipo:** ${plan1.planType}
- **Basado en:** ${plan1.basedOn}
- **Estado:** Superseded ‚Üí Plan 1.1

### üìÑ Consultation Report Utilizado
- **ID:** ${consultationReport._id}
- **Fecha consulta:** ${consultationReport.createdAt.toLocaleDateString('es-ES')}
- **Transcript length:** ${consultationReport.transcript.length} caracteres
- **Pediatra:** Dr. Mar√≠a Elena Rodr√≠guez

## üîç An√°lisis del Transcript

### Hallazgos Clave
${plan.transcriptAnalysis.keyFindings.map(finding => `- ${finding}`).join('\n')}

### Recomendaciones M√©dicas Extra√≠das
${plan.transcriptAnalysis.medicalRecommendations.map(rec => `- ${rec}`).join('\n')}

## üéØ Objetivos del Plan 1.1
${plan.objectives.map(obj => `- ${obj}`).join('\n')}

## ‚è∞ Horarios Refinados vs Plan 1

### üåô Rutina de Sue√±o
- **Hora de dormir:** Plan 1: ${plan1.schedule?.bedtime || 'N/A'} ‚Üí Plan 1.1: ${plan.schedule?.bedtime || 'N/A'}
- **Hora de despertar:** Plan 1: ${plan1.schedule?.wakeTime || 'N/A'} ‚Üí Plan 1.1: ${plan.schedule?.wakeTime || 'N/A'}
- **Siestas:** Plan 1: ${plan1.schedule?.naps?.[0]?.duration || 'N/A'} min ‚Üí Plan 1.1: ${plan.schedule?.naps?.[0]?.duration || 'N/A'} min

### üçΩÔ∏è Horarios de Comida
${plan.schedule?.meals ? plan.schedule.meals.map(meal => `- **${meal.time}** - ${meal.type}: ${meal.description}`).join('\n') : '- No disponible'}

### üéÆ Actividades Refinadas
${plan.schedule?.activities ? plan.schedule.activities.map(act => `- **${act.time}** - ${act.activity} (${act.duration} min): ${act.description}`).join('\n') : '- No disponible'}

## üîÑ Ajustes Espec√≠ficos Realizados
${plan.transcriptAnalysis.adjustments.map(adj => `- ${adj}`).join('\n')}

## üí° Recomendaciones del Plan 1.1
${plan.recommendations.map(rec => `- ${rec}`).join('\n')}

## üìà Mejoras Esperadas
${plan.transcriptAnalysis.improvements.map(imp => `- ${imp}`).join('\n')}

## üìä Fuentes de Datos Utilizadas
- ‚úÖ **Plan 1 como base:** Horarios y estructura establecida
- ‚úÖ **Transcript Analysis:** Consulta m√©dica del ${consultationReport.createdAt.toLocaleDateString('es-ES')}
- ‚úÖ **RAG Knowledge Base:** ${plan.transcriptAnalysis.ragSources.join(', ')}

## üéØ Implementaci√≥n y Seguimiento

### Pr√≥ximos Pasos:
1. **Implementar cambios gradualmente** durante 1-2 semanas
2. **Monitorear siesta:** Despertar si pasa de 45-60 minutos
3. **Evaluar necesidad de siesta:** Considerar eliminarla si persisten problemas
4. **Seguimiento m√©dico:** Revisar progreso en pr√≥xima consulta
5. **Posible Plan 2:** Basado en nuevos eventos post-implementaci√≥n

### Indicadores de √âxito:
- Conciliaci√≥n del sue√±o en <30 minutos
- Despertar natural entre 7:00-7:30 AM
- Reducci√≥n de inquietud vespertina
- Mejor estado de √°nimo matutino

---
*Plan de refinamiento generado autom√°ticamente el ${new Date('2025-06-16').toLocaleDateString('es-ES')} basado en an√°lisis de transcript m√©dico*

## üîß Informaci√≥n T√©cnica
- **Plan ID:** ${plan._id}
- **M√©todo generaci√≥n:** transcript_refinement
- **Plan base:** Plan 1 (${plan.basedOnPlan.planVersion})
- **Consultation Report ID:** ${plan.consultationReport.reportId}
- **Fuentes RAG:** ${plan.transcriptAnalysis.ragSources.length}
- **Total ajustes:** ${plan.transcriptAnalysis.adjustments.length}`

  await fs.writeFile('/Users/jaco/Desktop/nebula/proyectos_clientes/happy_dreamers_v0/pruebas/plan1-1.md', contenido, 'utf8')
  console.log('üìÑ Archivo plan1-1.md generado en /pruebas/')
}

// Ejecutar script
generarPlan1_1Esteban()