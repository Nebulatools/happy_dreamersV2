Resumen de generaci√≥n ‚Äì Plan 0 (initial)

- Fecha/hora: 2025-09-22T23:38:11Z ‚Üí 23:38:25Z
- Duraci√≥n: ~14.0s (processingTime: 14039 ms)
- childId: 68d1af5315d0e9b1cc189544
- userId (owner solicitado): 68d1a9b07e63c75df18e1c1c
- adminId (quien ejecuta): 68d1a9337e63c75df18e1c1b
- planId: 68d1ddf16992bac4eeec6971
- planNumber: 0
- planVersion: "0"
- planType: initial

Entradas usadas

- Datos del ni√±o (colecci√≥n `children`): perfil b√°sico + `birthDate` (para calcular `ageInMonths`) + `surveyData` si existe.
- Eventos hist√≥ricos (colecci√≥n `events`): se usa TODA la historia para estad√≠sticos del Plan 0.
- Estad√≠sticas calculadas (`lib/sleep-calculations.ts`):
  - avgSleepDuration, avgNapDuration, avgBedtime, avgSleepTime, avgWakeTime (inferido), bedtimeVariation,
    bedtimeToSleepDifference (delay promedio), totalWakeups, avgWakeupsPerNight, avgNightWakingDuration,
    totalSleepHours, totalEvents, recentEvents, sleepEvents, napEvents, dominantMood.
- Reglas/pol√≠ticas (`lib/plan-policies.ts`):
  - Transici√≥n de siestas (15‚Äì18m) y destete nocturno si hay `night_feeding` reciente.
- RAG (MongoDB Vector Store `lib/rag/vector-store-mongodb.ts`):
  - Consultas realizadas (top-2 por consulta, deduplicado por `metadata.source` hasta 6 fuentes):
    1) "rutina de sue√±o para ni√±os de 0 meses"
    2) "horarios de comida infantil"
    3) "siestas apropiadas por edad"
    4) "rutinas de acostarse"
  - Resultados reportados en logs: 2, 2, 2, 2

Proceso (alto nivel)

1) Verificaci√≥n de permisos (admin) y existencia de planes previos.
2) C√°lculo de versi√≥n siguiente: Plan 0 ‚Üí n√∫mero 0, versi√≥n "0".
3) Carga de perfil del ni√±o y eventos; c√°lculo de `ageInMonths` y estad√≠sticas.
4) B√∫squeda RAG con las 4 queries anteriores; se adjuntan fragmentos y fuente al prompt.
5) Inyecci√≥n de pol√≠ticas de ajuste (si aplica) en el prompt de sistema.
6) Llamado a IA (GPT-4) con formato JSON estricto para generar: schedule (bedtime, wakeTime, meals, naps), objectives, recommendations.
7) Guardado en `child_plans` con `basedOn: "survey_stats_rag"` y `sourceData` (incluye `ragSources`, `ageInMonths`, `totalEvents`).

Salida (lo observado en UI)

- Rutina con horarios:
  - 07:00 Despertar
  - 07:30 Feeding
  - 09:00 Siesta 60 min
  - 10:00 Feeding
  - 12:00 Siesta 60 min
  - 13:00 Feeding
  - 15:00 Siesta 60 min
  - 16:00 Feeding
  - 19:00 Feeding
  - 19:00 Hora de dormir

C√≥mo verificar fuentes y datos base del plan (API)

- GET `/api/consultas/plans?userId=68d1a9b07e63c75df18e1c1c&childId=68d1af5315d0e9b1cc189544`
  - Buscar el plan con `planNumber: 0`.
  - Revisar campos:
    - `basedOn` debe ser `"survey_stats_rag"`.
    - `sourceData.surveyDataUsed` (true/false seg√∫n exista survey).
    - `sourceData.childStatsUsed` (true) y `sourceData.totalEvents`.
    - `sourceData.ragSources`: lista de fuentes exactas usadas por el RAG.
    - `sourceData.ageInMonths`: edad usada por el prompt.

Extracto de logs relevantes (limpio)

```
[API:consultas:plans:route] INFO: Iniciando generaci√≥n de plan { userId: '68d1a9b07e63c75df18e1c1c', childId: '68d1af5315d0e9b1cc189544', planType: 'initial', reportId: undefined, adminId: '68d1a9337e63c75df18e1c1b' }
[API:consultas:plans:route] INFO: Generando plan inicial { userId: '68d1a9b07e63c75df18e1c1c', childId: '68d1af5315d0e9b1cc189544' }
[vector-store-mongodb] INFO: üîç B√∫squeda vectorial en MongoDB: "rutina de sue√±o para ni√±os de 0 meses"
[vector-store-mongodb] INFO: ‚úÖ 2 resultados encontrados
[vector-store-mongodb] INFO: üîç B√∫squeda vectorial en MongoDB: "horarios de comida infantil"
[vector-store-mongodb] INFO: ‚úÖ 2 resultados encontrados
[vector-store-mongodb] INFO: üîç B√∫squeda vectorial en MongoDB: "siestas apropiadas por edad"
[vector-store-mongodb] INFO: ‚úÖ 2 resultados encontrados
[vector-store-mongodb] INFO: üîç B√∫squeda vectorial en MongoDB: "rutinas de acostarse"
[vector-store-mongodb] INFO: ‚úÖ 2 resultados encontrados
[API:consultas:plans:route] INFO: Plan generado exitosamente { planId: 68d1ddf16992bac4eeec6971, planNumber: 0, planVersion: '0', planType: 'initial', childId: '68d1af5315d0e9b1cc189544', processingTime: 14039 }
```

Referencias de c√≥digo

- Endpoint y flujo: `app/api/consultas/plans/route.ts`
  - `generateInitialPlan` (Plan 0)
  - `searchRAGForPlan` (consultas RAG)
  - `generatePlanWithAI` (prompt + policies + parseo JSON)
- Estad√≠sticas: `lib/sleep-calculations.ts`
- Pol√≠ticas: `lib/plan-policies.ts`
- Vector store RAG (MongoDB): `lib/rag/vector-store-mongodb.ts`

