---
id: plan-20251028-2147
timestamp: 2025-10-28T21:47:00Z
research_ref: research-20251029-0251
objective: "Activar una experiencia de calendario compacta para usuarios estándar sin afectar la vista rica del rol admin."
scope: "Frontend (Next.js/React) en rama ui/ux; ajustes de componentes, layout y estados de UI. Sin cambios en backend ni modelos de datos."
assumptions:
  - "La detección de roles está disponible vía sesión NextAuth en el cliente."
  - "Los componentes compactos existentes (`CompactTimelineColumn`, `CompactEventBlock`) están listos para ser reutilizados."
  - "Los entornos de pruebas (Jest/RTL) y Storybook/Playwright están operativos en la rama ui/ux."
constraints:
  - "No modificar código fuera de docs/analysis/ en esta fase preliminar."
  - "Mantener compatibilidad total con la vista actual de admin (Mariana)."
  - "No tocar APIs, modelos ni lógica de datos en backend."
success_criteria_summary:
  - "Usuarios no-admin ven cronograma semanal en modo compacto sin pérdida de datos accesibles."
  - "Admins conservan vista completa actual sin regresiones visuales."
  - "Las rutas de calendario siguen cargando con tiempos equivalentes o mejores en perfiles estándar."
---

# Tabla de contenido
- [1) Objetivo, alcance y no-objetivos](#1-objetivo-alcance-y-no-objetivos)
- [2) Arquitectura propuesta (resumen y diagrama textual)](#2-arquitectura-propuesta-resumen-y-diagrama-textual)
- [3) Plan por fases](#3-plan-por-fases)
  - [Fase 1 — Plataforma de roles y variantes](#fase-1--plataforma-de-roles-y-variantes)
  - [Fase 2 — Vista compacta por defecto para usuarios estándar](#fase-2--vista-compacta-por-defecto-para-usuarios-estándar)
  - [Fase 3 — Controles de detalle, QA visual y documentación](#fase-3--controles-de-detalle-qa-visual-y-documentación)
- [4) Estrategia de pruebas y verificación](#4-estrategia-de-pruebas-y-verificación)
- [5) Riesgos y mitigaciones](#5-riesgos-y-mitigaciones)
- [6) Plan de commits (por fase)](#6-plan-de-commits-por-fase)
- [7) Checklist de finalización](#7-checklist-de-finalización)

## 1) Objetivo, alcance y no-objetivos
**Objetivo operacional**: habilitar una experiencia de calendario más ligera para usuarios estándar reutilizando variantes compactas existentes, preservando la vista completa para administradores.

**Alcance**
- Frontend (Next.js 15 / React 19) en la rama `ui/ux`.
- Componentes en `app/dashboard/calendar/` y `components/calendar/`.
- Ajustes de estados/contextos para decidir qué variante renderizar según rol.
- Refinamiento de tooltips/modales para exponer datos completos bajo demanda.

**No-objetivos**
- Cambios en APIs, modelos MongoDB o servicios backend.
- Modificaciones en lógica de generación de eventos o cron jobs.
- Refactors globales del sistema de roles o autenticación.
- Implementación de funcionalidades nuevas de calendario (solo presentación).

**Restricciones relevantes**
- El plan debe ejecutarse únicamente en la rama `ui/ux`.
- Se debe mantener la compatibilidad con vistas móvil y desktop.
- No romper la experiencia del rol admin ni sus flujos de edición.

**Suposiciones clave**
- Las funciones de obtención de sesión (`useSession` / `getServerSession`) siguen accesibles en la página del calendario.
- Los estilos Tailwind y tokens de diseño actuales soportan variantes compactas sin conflicto.
- Los equipos de QA pueden ejecutar suites existentes (Jest/RTL) y pruebas manuales en staging.

## 2) Arquitectura propuesta (resumen y diagrama textual)
La propuesta se apoya en dos variantes de componentes: “full” (actual) y “compacta”. El cliente decidirá qué variante mostrar según el rol del usuario.

**Flujo textual**
```
[NextAuth session] -> [Calendar role guard]
  -> if role === 'admin' | 'power' -> [CalendarMain] usa (TimelineColumn + EventBlock)
  -> else -> [CalendarMain] usa (CompactTimelineColumn + CompactEventBlock)
      -> detalles completos accesibles vía [EventDetailsModal] / tooltips
```

Componentes a coordinar:
- `app/dashboard/calendar/page.tsx`: punto de entrada; determinar rol y pasar flags a `CalendarMain`.
- `components/calendar/CalendarMain.tsx`: orquestador de timeline/eventos; conmutará entre variantes.
- Variantes compactas existentes (`CompactTimelineColumn`, `CompactEventBlock`).
- Toolbars y modales (`CalendarToolbar`, `EventDetailsModal`) para exponer datos completos bajo demanda.
- Contexto/estado global si se requiere compartir la preferencia del usuario (por ejemplo, “usar vista completa temporalmente”).

## 3) Plan por fases

### Tabla de impacto por fase
| Fase | Archivo | Acción | Símbolos/Secciones | Notas |
| --- | --- | --- | --- | --- |
| 1 | app/dashboard/calendar/page.tsx | Modificar | Inicialización de `CalendarMain`, hooks de sesión | Añadir detección de rol y flag `viewMode`. |
| 1 | components/calendar/CalendarMain.tsx | Modificar | Props y render principal | Aceptar `viewMode`, elegir variantes. |
| 1 | components/calendar/index.ts | Modificar | Exportaciones | Normalizar export para variantes. |
| 1 | types/calendar.ts (crear si no existe) | Crear | Tipos `CalendarViewMode`, mapping de roles | Opcional si no hay tipado central. |
| 2 | components/calendar/TimelineColumn.tsx | Modificar | Render condicional, estilos compactos | Ajustar layout y reutilizar compacto. |
| 2 | components/calendar/EventBlock.tsx | Modificar | Render condicional, tooltips | Simplificar densidad default. |
| 2 | components/calendar/CalendarToolbar.tsx | Modificar | Controles visuales | Mostrar badges/indicadores de vista compacta. |
| 2 | styles/calendar.css o tailwind classes | Modificar | Tokens de espaciado | Ajustar alturas mínimas. |
| 3 | components/calendar/CalendarToolbar.tsx | Modificar | Toggle temporal “Ver detalles completos” | Colocar switch usuario. |
| 3 | components/events/EventDetailsModal.tsx | Modificar | Asegurar acceso a datos completos | Confirmar props/trigger. |
| 3 | __tests__/calendar/*.test.tsx | Modificar/Crear | Casos para viewMode | Validar render variantes. |
| 3 | docs/CHANGELOG-PARENT-DASHBOARD.md | Modificar | Documentar cambios UX | Entrada para release. |
| 3 | docs/analysis/*.md | Modificar | Actualizar notas QA | Añadir resultados si aplica. |

### Tabla de criterios por fase
| Fase | Criterio | Métrica/Prueba | Umbral | Responsable |
| --- | --- | --- | --- | --- |
| 1 | Detección de rol y flag funcionando | Test unitario render admin vs parent | 100% passing | Frontend |
| 1 | Vista admin sin cambios | Snapshot visual Storybook/regresión | Diferencias 0 | Frontend + QA |
| 2 | Vista estándar reduce densidad | Comparación altura columna (lite ≤70% de full) | ≤0.7 ratio | Diseño/Frontend |
| 2 | Eventos siguen accesibles | RTL test: compact -> modal abre con info completa | 100% | QA |
| 3 | Toggle manual disponible | RTL test: switch view -> cambia variante | 100% | Frontend |
| 3 | Documentación y changelog actualizados | Revisión docs | Completo | Tech Writer |

### Fase 1 — Plataforma de roles y variantes
**Objetivo**: Detectar rol en el calendario y propagar un modo de vista (`full` vs `compact`) sin alterar todavía la presentación.

**Pasos**
1. Actualizar `app/dashboard/calendar/page.tsx` para obtener rol desde `useSession`/`getServerSession` y definir `viewMode` (p.ej., `const viewMode = isAdmin ? 'full' : 'compact'`).
2. Extender `CalendarMain` para aceptar `viewMode` y propagarlo a subcomponentes clave (timeline, events, toolbar).
3. Centralizar los tipos y helpers (`types/calendar.ts`) para evitar “magic strings”.
4. Ajustar `components/calendar/index.ts` y consumidores para que las importaciones sigan consistentes.
5. Crear tests unitarios/RTL mínimos que verifiquen que `CalendarMain` recibe el modo correcto según rol simulado.

**Criterios de éxito**
- Las pruebas unitarias confirman que el modo esperado se pasa a `CalendarMain` según rol.
- Vista admin renderiza exactamente igual (comparación de snapshot o Percy).

**Verificación**
- `pnpm test calendar -- --runTestsByPath __tests__/calendar/calendar-main.spec.tsx`
- Revisión manual en Storybook (si disponible) con mocks de rol admin y parent.

**Riesgos y mitigación**
- *Riesgo*: Conflictos con SSR/CSR al leer sesión -> Mitigar utilizando fallback `loading` y comprobaciones null-safe.
- *Riesgo*: Props faltantes en subcomponentes -> Mitigar con tipos estrictos y tests.

**Rollback**
- `git checkout app/dashboard/calendar/page.tsx components/calendar/CalendarMain.tsx components/calendar/index.ts`.

### Fase 2 — Vista compacta por defecto para usuarios estándar
**Objetivo**: Activar las variantes compactas y ajustar estilos para usuarios no-admin.

**Pasos**
1. En `CalendarMain`, usar `viewMode` para decidir entre `TimelineColumn` vs `CompactTimelineColumn`, y `EventBlock` vs `CompactEventBlock`.
2. Revisar `TimelineColumn.tsx` y `EventBlock.tsx` para asegurar que las variantes compactas cubren todos los props necesarios; ajustar alturas (ej. `min-h-6` → `min-h-4`), tipografía y truncado.
3. Actualizar `CalendarToolbar` para indicar visualmente el modo (badge “Vista ligera” con tooltip explicativo).
4. Ajustar estilos/Tailwind tokens necesarios para reducir densidad (controlar spacing vertical, paddings y `max-h`).
5. Validar que modales siguen mostrando detalles completos al hacer click/tap en evento.

**Criterios de éxito**
- Vista estándar reduce altura total del día ≥30% vs full (medido inspeccionando DOM o screenshot comparativo).
- Eventos siguen accesibles y modales muestran información completa.

**Verificación**
- Prueba manual en navegador con usuario estándar: timeline semanal sin scroll vertical adicional en desktop ≤1080p.
- `pnpm test calendar -- --runTestsByPath __tests__/calendar/event-block.spec.tsx`.
- Lighthouse o Web Vitals para confirmar que no se degrada performance.

**Riesgos y mitigación**
- *Riesgo*: Colisiones de estilos en responsive -> usar breakpoints tailwind y test en mobile view.
- *Riesgo*: Accesibilidad (lectura truncada) -> añadir tooltips/`aria-label`.

**Rollback**
- `git checkout components/calendar/*.tsx styles/...` restaurando commits de fase.

### Fase 3 — Controles de detalle, QA visual y documentación
**Objetivo**: Dar control manual a usuarios, garantizar QA, y documentar los cambios.

**Pasos**
1. Añadir en `CalendarToolbar` un toggle (e.g., `Switch` de shadcn) que permita al usuario estándar activar temporalmente la vista completa.
2. Persistir la preferencia en `localStorage` (opcional) o estado URL (`?view=full`) para recargas dentro de la sesión.
3. Garantizar que `EventDetailsModal` y otras superficies muestran datos completos al invocarse desde vista compacta; documentar fallback.
4. Crear/actualizar pruebas RTL para garantizar que el toggle cambia la variante y que los modales muestran contenido completo.
5. Actualizar documentación: `docs/CHANGELOG-PARENT-DASHBOARD.md` y notas internas en `docs/analysis/` con resultados de QA.

**Criterios de éxito**
- Toggle funciona al 100% en pruebas automáticas y manuales.
- Documentación refleja la funcionalidad y pasos de QA.

**Verificación**
- `pnpm test calendar -- --runTestsByPath __tests__/calendar/calendar-toolbar.spec.tsx`.
- QA manual: flujos de creación/edición en ambas vistas.

**Riesgos y mitigación**
- *Riesgo*: Toggle disponible accidentalmente para admin -> condicionar render según rol.
- *Riesgo*: Estado de preferencia inconsistente -> fallback a modo `compact` en caso de error y limpiar storage.

**Rollback**
- `git checkout components/calendar/CalendarToolbar.tsx components/events/EventDetailsModal.tsx docs/CHANGELOG-PARENT-DASHBOARD.md`.

## 4) Estrategia de pruebas y verificación
- **Unitarias**: RTL para `CalendarMain`, `EventBlock`, `CalendarToolbar` con mocks de rol y modos.
- **Integración**: Pruebas de navegación en `app/dashboard/calendar/page.tsx` usando Playwright o Cypress (si disponible) para alternar roles y validar UI.
- **Visuales**: Capturas Percy/Loki o comparaciones manuales en Storybook para admin vs estándar.
- **Performance ligera**: Lighthouse/Web Vitals en vista compacta para confirmar tiempos de interacción.
- **Accesibilidad**: `pnpm lint:a11y` o `axe` manual sobre timeline compacto.

## 5) Riesgos y mitigaciones
| Riesgo | Área | Probabilidad | Impacto | Severidad | Mitigación |
| --- | --- | --- | --- | --- | --- |
| Vista admin afectada por refactor de props | UX Admin | Media | Alta | Alta | Mantener snapshots visuales y pruebas específicas de rol admin.
| Inconsistencia de datos al truncar contenido | Datos visibles | Media | Media | Media | Usar tooltips/hover y modales completos; QA manual.
| Regresiones responsive en mobile | Responsive | Alta | Media | Alta | Test en breakpoints, usar devtools mobile, añadir test RTL con `window.innerWidth`.
| Problemas de accesibilidad (texto truncado sin `aria`) | Accesibilidad | Media | Media | Media | Añadir `aria-label` y `sr-only` para información completa.
| Toggle preferencia causa loops de render | Estado cliente | Baja | Media | Baja | Debounce acceso a storage, usar `useEffect` con guardas.

## 6) Plan de commits (por fase)
1. **Fase 1** — `feat(calendar): add role-aware view mode wiring`
2. **Fase 2** — `feat(calendar): default compact layout for standard users`
3. **Fase 3** — `feat(calendar): add full-view toggle and update docs`

## 7) Checklist de finalización
- [ ] Fase 1 completada y pruebas unitarias green.
- [ ] Fase 2 activada con validación de densidad ≤70% y QA responsivo.
- [ ] Fase 3 con toggle funcional y documentación actualizada.
- [ ] Suite de pruebas (unitarias/integración) ejecutada sin fallas.
- [ ] Registros de QA visual y accesibilidad archivados.
- [ ] Changelog y notas internas actualizadas.
