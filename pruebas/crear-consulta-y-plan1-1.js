// Script para crear consulta + Plan 1.1 de Esteban - 16 de junio 2025
// Primero crea la consulta, luego genera Plan 1.1

require('dotenv').config()
const { MongoClient, ObjectId } = require('mongodb')
const fs = require('fs').promises

const MONGODB_URI = process.env.MONGODB_URI
const USER_ID = '688ce146d2d5ff9616549d86'
const ESTEBAN_ID = '68ad0476b98bdbe0f7ff5942'
const ADMIN_ID = '687999869a879ac61e9fb873'

async function crearConsultaYPlan1_1() {
  try {
    console.log('üåü CREAR CONSULTA + PLAN 1.1 PARA ESTEBAN')
    console.log('=========================================')
    
    const client = new MongoClient(MONGODB_URI)
    await client.connect()
    console.log('‚úÖ Conectado a MongoDB')
    
    const db = client.db()
    
    // 1. Leer transcript del archivo
    const transcriptContent = await fs.readFile('/Users/jaco/Desktop/nebula/proyectos_clientes/happy_dreamers_v0/pruebas/esteban_consulta.md', 'utf8')
    console.log(`üìÑ Transcript le√≠do: ${transcriptContent.length} caracteres`)
    
    // 2. Crear consultation report
    const consultationReport = {
      _id: new ObjectId(),
      childId: new ObjectId(ESTEBAN_ID),
      userId: new ObjectId(USER_ID),
      transcript: transcriptContent,
      analysis: "An√°lisis m√©dico detallado: Se identifican problemas de sue√±o relacionados con siesta muy larga (90 min) que afecta conciliaci√≥n nocturna. Recomendaciones espec√≠ficas incluyen reducir siesta a 45-60 min m√°ximo, aumentar actividad f√≠sica matutina, y establecer rutina de relajaci√≥n pre-sue√±o. Considerar eliminaci√≥n completa de siesta si persisten problemas.",
      recommendations: [
        "Reducir siesta a m√°ximo 45-60 minutos",
        "Despertar a Esteban si la siesta supera los 60 minutos",
        "Aumentar actividad f√≠sica especialmente en ma√±anas",
        "Implementar rutina de relajaci√≥n 30 min antes de dormir",
        "Considerar eliminar siesta si persisten problemas de conciliaci√≥n"
      ],
      createdAt: new Date('2025-06-16T11:00:00.000Z'),
      updatedAt: new Date('2025-06-16T11:00:00.000Z')
    }
    
    await db.collection('consultation_reports').insertOne(consultationReport)
    console.log(`‚úÖ Consultation report creado: ${consultationReport._id}`)
    
    // 3. Buscar Plan 1
    const plan1 = await db.collection('child_plans').findOne({
      childId: new ObjectId(ESTEBAN_ID),
      planVersion: "1"
    })
    
    if (!plan1) {
      console.error('‚ùå No se encontr√≥ Plan 1')
      return
    }
    
    console.log(`üìã Plan 1 encontrado: ${plan1._id}`)
    
    // 4. Crear Plan 1.1
    const plan1_1 = {
      _id: new ObjectId(),
      childId: new ObjectId(ESTEBAN_ID),
      userId: new ObjectId(USER_ID),
      planNumber: 1,
      planVersion: "1.1",
      planType: "transcript_refinement",
      
      schedule: {
        bedtime: "20:00", // Adelantado 15 min seg√∫n m√©dico
        wakeTime: "07:00", // Mejorado para m√°s descanso
        meals: [
          {
            time: "07:30",
            type: "desayuno",
            description: "Desayuno despu√©s de despertar naturalmente"
          },
          {
            time: "12:30",
            type: "almuerzo", 
            description: "Almuerzo balanceado manteniendo horario"
          },
          {
            time: "16:00",
            type: "merienda",
            description: "Merienda ligera temprana"
          },
          {
            time: "19:00",
            type: "cena",
            description: "Cena temprana para mejor digesti√≥n nocturna"
          }
        ],
        activities: [
          {
            time: "08:00",
            activity: "jugar",
            duration: 60,
            description: "Juego libre matutino con m√°s actividad f√≠sica"
          },
          {
            time: "10:00",
            activity: "ejercicio",
            duration: 45,
            description: "Actividad f√≠sica intensa matutina (recomendaci√≥n m√©dica)"
          },
          {
            time: "17:00",
            activity: "actividad_tranquila",
            duration: 30,
            description: "Actividades tranquilas despu√©s de las 5 PM"
          },
          {
            time: "19:30",
            activity: "rutina_relajacion",
            duration: 30,
            description: "Rutina de relajaci√≥n: lectura y preparaci√≥n para dormir"
          }
        ],
        naps: [
          {
            time: "14:30",
            duration: 45, // Reducido de 75 a 45 min
            description: "Siesta reducida a 45 min m√°ximo (recomendaci√≥n m√©dica)"
          }
        ]
      },
      
      title: "Plan 1.1 de Refinamiento M√©dico para Esteban",
      objectives: [
        "Reducir siesta a m√°ximo 45-60 minutos seg√∫n recomendaci√≥n m√©dica",
        "Adelantar hora de dormir a 20:00 para mejorar conciliaci√≥n",
        "Aumentar actividad f√≠sica matutina para mejor cansancio nocturno",
        "Implementar rutina de relajaci√≥n estricta 30 min antes de dormir",
        "Establecer 'tiempo tranquilo' si no tiene sue√±o para siesta"
      ],
      recommendations: [
        "Despertar a Esteban si la siesta pasa de 45-60 minutos",
        "Considerar eliminar siesta completamente si persisten problemas",
        "Mantener cuarto entre 18-21¬∞C para √≥ptimo descanso",
        "Implementar 'tiempo tranquilo' con libros si no quiere dormir siesta",
        "Ser pacientes: cambios pueden tomar 1-2 semanas en establecerse",
        "Aumentar actividad f√≠sica especialmente en ma√±ana y temprano en tarde",
        "Evitar actividades estimulantes despu√©s de las 6:00 PM"
      ],
      
      basedOn: "transcript_analysis",
      
      basedOnPlan: {
        planId: plan1._id,
        planVersion: plan1.planVersion
      },
      
      consultationReport: {
        reportId: consultationReport._id,
        analysisDate: consultationReport.createdAt,
        transcriptLength: consultationReport.transcript.length
      },
      
      transcriptAnalysis: {
        keyFindings: [
          "Siesta muy larga (90 min) est√° afectando sue√±o nocturno",
          "Dificultad para conciliar el sue√±o en la noche",
          "Despertares tempranos pero con cansancio residual",
          "Inquietud despu√©s de las 5:00 PM",
          "Necesidad de m√°s actividad f√≠sica durante el d√≠a"
        ],
        medicalRecommendations: [
          "Reducir siesta a m√°ximo 45-60 minutos",
          "Considerar eliminar siesta si persisten problemas",
          "Aumentar actividad f√≠sica matutina",
          "Implementar rutina de relajaci√≥n pre-sue√±o",
          "Mantener ambiente fresco (18-21¬∞C)"
        ],
        adjustments: [
          "Hora de dormir: 20:15 ‚Üí 20:00 (15 min m√°s temprano)",
          "Siesta: 75 min ‚Üí 45 min (30 min menos)",
          "Actividad f√≠sica: agregada sesi√≥n matutina de 45 min",
          "Rutina pre-sue√±o: especificada con tiempo tranquilo"
        ],
        improvements: [
          "Mejor conciliaci√≥n del sue√±o nocturno",
          "Reducci√≥n de despertares tempranos",
          "Mayor cansancio natural por m√°s actividad f√≠sica",
          "Rutina m√°s estructurada para relajaci√≥n"
        ],
        ragSources: [
          "Transici√≥n de siesta a los 4-5 a√±os",
          "Impacto de siesta larga en sue√±o nocturno",
          "Actividad f√≠sica y calidad del sue√±o infantil",
          "Rutinas de relajaci√≥n pre-sue√±o"
        ]
      },
      
      createdAt: new Date('2025-06-16T16:00:00.000Z'),
      updatedAt: new Date('2025-06-16T16:00:00.000Z'),
      createdBy: new ObjectId(ADMIN_ID),
      status: "active"
    }
    
    // 5. Marcar Plan 1 como superseded
    await db.collection('child_plans').updateOne(
      { _id: plan1._id },
      { $set: { status: "superseded" } }
    )
    
    // 6. Insertar Plan 1.1
    const result = await db.collection('child_plans').insertOne(plan1_1)
    
    console.log('\n‚úÖ PLAN 1.1 GENERADO EXITOSAMENTE')
    console.log('================================')
    console.log(`üìù Plan ID: ${result.insertedId}`)
    console.log(`üéØ Tipo: transcript_refinement (Plan 1.1)`)
    console.log(`üìä Basado en: Plan 1 + Transcript Analysis + RAG`)
    console.log(`‚è∞ Horario dormir: ${plan1_1.schedule.bedtime}`)
    console.log(`üåÖ Horario despertar: ${plan1_1.schedule.wakeTime}`)
    console.log(`üò¥ Siesta: ${plan1_1.schedule.naps[0].duration} min`)
    
    // 7. Generar plan1-1.md
    await generarPlan1_1Markdown(plan1_1, plan1, consultationReport)
    
    await client.close()
    console.log('\nüéâ PROCESO COMPLETADO - CONSULTA + PLAN 1.1 CREADOS')
    
  } catch (error) {
    console.error('‚ùå Error:', error)
    process.exit(1)
  }
}

async function generarPlan1_1Markdown(plan1_1, plan1, consultationReport) {
  const contenido = `# Plan 1.1 - Esteban Benavides Garc√≠a
**Fecha de generaci√≥n:** 16 de junio, 2025  
**Tipo:** Plan de Refinamiento M√©dico  
**Versi√≥n:** ${plan1_1.planVersion}  
**Basado en:** Plan 1 + An√°lisis de Transcript + RAG Knowledge Base

## üë∂ Informaci√≥n del Ni√±o
- **Nombre:** Esteban Benavides Garc√≠a
- **Fecha nacimiento:** 2021-02-12
- **Edad:** 52 meses
- **Plan anterior:** Plan 1 (creado el 15 de junio 2025)

## üìä Progresi√≥n desde Plan 1

### üìÖ Plan 1 (Base para refinamiento)
- **Creado:** ${plan1.createdAt.toLocaleDateString('es-ES')}
- **Tipo:** ${plan1.planType}
- **Basado en:** ${plan1.basedOn}
- **Estado:** Superseded ‚Üí Plan 1.1

### üìÑ Consultation Report Utilizado
- **ID:** ${consultationReport._id}
- **Fecha consulta:** ${consultationReport.createdAt.toLocaleDateString('es-ES')}
- **Transcript length:** ${consultationReport.transcript.length} caracteres
- **Pediatra:** Dr. Mar√≠a Elena Rodr√≠guez

## üîç An√°lisis del Transcript

### Hallazgos Clave
${plan1_1.transcriptAnalysis.keyFindings.map(finding => `- ${finding}`).join('\n')}

### Recomendaciones M√©dicas Extra√≠das
${plan1_1.transcriptAnalysis.medicalRecommendations.map(rec => `- ${rec}`).join('\n')}

## üéØ Objetivos del Plan 1.1
${plan1_1.objectives.map(obj => `- ${obj}`).join('\n')}

## ‚è∞ Horarios Refinados vs Plan 1

### üåô Rutina de Sue√±o
- **Hora de dormir:** Plan 1: ${plan1.schedule?.bedtime || 'N/A'} ‚Üí Plan 1.1: ${plan1_1.schedule?.bedtime || 'N/A'}
- **Hora de despertar:** Plan 1: ${plan1.schedule?.wakeTime || 'N/A'} ‚Üí Plan 1.1: ${plan1_1.schedule?.wakeTime || 'N/A'}
- **Siestas:** Plan 1: ${plan1.schedule?.naps?.[0]?.duration || 'N/A'} min ‚Üí Plan 1.1: ${plan1_1.schedule?.naps?.[0]?.duration || 'N/A'} min

### üçΩÔ∏è Horarios de Comida
${plan1_1.schedule?.meals ? plan1_1.schedule.meals.map(meal => `- **${meal.time}** - ${meal.type}: ${meal.description}`).join('\n') : '- No disponible'}

### üéÆ Actividades Refinadas
${plan1_1.schedule?.activities ? plan1_1.schedule.activities.map(act => `- **${act.time}** - ${act.activity} (${act.duration} min): ${act.description}`).join('\n') : '- No disponible'}

## üîÑ Ajustes Espec√≠ficos Realizados
${plan1_1.transcriptAnalysis.adjustments.map(adj => `- ${adj}`).join('\n')}

## üí° Recomendaciones del Plan 1.1
${plan1_1.recommendations.map(rec => `- ${rec}`).join('\n')}

## üìà Mejoras Esperadas
${plan1_1.transcriptAnalysis.improvements.map(imp => `- ${imp}`).join('\n')}

## üìä Fuentes de Datos Utilizadas
- ‚úÖ **Plan 1 como base:** Horarios y estructura establecida del 15 de junio
- ‚úÖ **Transcript Analysis:** Consulta m√©dica del ${consultationReport.createdAt.toLocaleDateString('es-ES')}
- ‚úÖ **RAG Knowledge Base:** ${plan1_1.transcriptAnalysis.ragSources.join(', ')}

## üéØ Validaci√≥n de Fuentes

### ‚úÖ CONFIRMACI√ìN: Solo usa Plan 1 + Transcript
- **Plan base:** Plan 1 (versi√≥n ${plan1.planVersion})
- **Plan base ID:** ${plan1._id}
- **NO usa eventos adicionales** (como debe ser)
- **Transcript analysis:** S√≠, completo
- **RAG integration:** S√≠, especializado en refinamiento m√©dico

### üìã Metadata T√©cnica
- **Plan ID:** ${plan1_1._id}
- **M√©todo generaci√≥n:** transcript_refinement
- **Consultation Report ID:** ${plan1_1.consultationReport.reportId}
- **Fuentes RAG:** ${plan1_1.transcriptAnalysis.ragSources.length}
- **Total ajustes:** ${plan1_1.transcriptAnalysis.adjustments.length}

---
*Plan de refinamiento generado autom√°ticamente el ${new Date('2025-06-16').toLocaleDateString('es-ES')} basado exclusivamente en Plan 1 + an√°lisis de transcript m√©dico*`

  await fs.writeFile('/Users/jaco/Desktop/nebula/proyectos_clientes/happy_dreamers_v0/pruebas/plan1-1.md', contenido, 'utf8')
  console.log('üìÑ Archivo plan1-1.md generado en /pruebas/')
}

// Ejecutar script
crearConsultaYPlan1_1()